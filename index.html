<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2D Mining Game — Inventory + Keymap Update</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html,body{margin:0;padding:0;background:#0b0d12;color:#e5e7eb;font:14px/1.3 system-ui}
  #ui{position:fixed;top:8px;left:8px;right:8px;display:flex;gap:8px;align-items:center;z-index:10}
  .panel{background:#111827;border:1px solid #1f2937;border-radius:8px;padding:8px 10px;box-shadow:0 2px 8px rgba(0,0,0,.35)}
  #game{display:block;width:100vw;height:100vh;image-rendering:pixelated}
</style>
</head>
<body>
  <div id="ui">
    <div class="panel" id="stats"></div>
  </div>
  <canvas id="game" width="1280" height="720"></canvas>
  <div id="toasts" class="fixed top-4 right-4 z-30 space-y-2 pointer-events-none"></div>

  <!-- Shop modal -->
  <div id="shopModal" class="hidden fixed inset-0 z-20 flex items-center justify-center bg-black/50">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-xl w-[480px] max-w-[92vw]">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700">
        <h3 class="text-base font-semibold">Surface Shop</h3>
        <button id="shopClose" class="px-2 py-1 text-sm rounded-md border border-slate-700 hover:bg-slate-800">Close</button>
      </div>
      <div class="p-4 space-y-3 text-sm" id="shopBody"></div>
    </div>
  </div>

  <!-- Inventory modal -->
  <div id="invModal" class="hidden fixed inset-0 z-20 flex items-center justify-center bg-black/50">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-xl w-[480px] max-w-[92vw]">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700">
        <h3 class="text-base font-semibold">Inventory</h3>
        <button id="invClose" class="px-2 py-1 text-sm rounded-md border border-slate-700 hover:bg-slate-800">Close</button>
      </div>
      <div class="p-4 grid grid-cols-4 gap-2 text-sm" id="invGrid"></div>
    </div>
  </div>

<script>
(() => {
  // ---- Config
  const TILE=24, MAP_W=200, MAP_H=200;
  const MOVE_ACC=1.2, MAX_HSPEED=5, GRAV=0.9, FRICTION=0.85;

  // ---- Materials
  const MATERIALS=[
    {id:0,name:'Air',     color:null,      solid:false,hard:0,value:0, weight:0},
    {id:1,name:'Grass',   color:'#16a34a', solid:true, hard:1,value:0, weight:1},
    {id:2,name:'Dirt',    color:'#4d3b2f', solid:true, hard:1,value:0, weight:1},
    {id:3,name:'Stone',   color:'#6b7280', solid:true, hard:2,value:1, weight:2},
    {id:4,name:'Copper',  color:'#b87333', solid:true, hard:3,value:5, weight:3},
    {id:5,name:'Iron',    color:'#a3a3a3', solid:true, hard:4,value:10,weight:4},
    {id:6,name:'Silver',  color:'#c0c0c0', solid:true, hard:5,value:18,weight:5},
    {id:7,name:'Gold',    color:'#eab308', solid:true, hard:6,value:30,weight:6}
  ];

  // ---- Canvas / UI
  const canvas=document.getElementById('game');
  const ctx=canvas.getContext('2d');
  const statsEl=document.getElementById('stats');
  const toastWrap=document.getElementById('toasts');
  const shopModal=document.getElementById('shopModal');
  const shopBody =document.getElementById('shopBody');
  const invModal =document.getElementById('invModal');
  const invGrid  =document.getElementById('invGrid');
  document.getElementById('shopClose').onclick=()=>closeAllModals();
  document.getElementById('invClose').onclick =()=>closeAllModals();

  // Toasts
  function say(text){
    const el=document.createElement('div');
    el.className='pointer-events-auto select-none bg-slate-900/95 border border-slate-700 shadow-lg rounded-lg px-3 py-2 text-sm flex items-center gap-2';
    el.textContent=text; toastWrap.appendChild(el);
    setTimeout(()=>{ el.style.transition='opacity .25s ease'; el.style.opacity='0'; setTimeout(()=>el.remove(), 260); }, 2200);
  }

  function openModal(el){ el.classList.remove('hidden'); el.classList.add('flex'); }
  function closeModal(el){ el.classList.add('hidden'); el.classList.remove('flex'); }
  function closeAllModals(){ closeModal(shopModal); closeModal(invModal); }
  function isUIOpen(){ return !shopModal.classList.contains('hidden') || !invModal.classList.contains('hidden'); }

  // ---- World
  const world={
    tiles:new Uint8Array(MAP_W*MAP_H),
    get(x,y){ if(x<0||y<0||x>=MAP_W||y>=MAP_H) return 3; return this.tiles[y*MAP_W+x]; },
    set(x,y,v){ if(x<0||y<0||x>=MAP_W||y>=MAP_H) return; this.tiles[y*MAP_W+x]=v; }
  };
  function generateWorld(){
    for(let y=0;y<MAP_H;y++){
      for(let x=0;x<MAP_W;x++){
        if(y<5){ world.set(x,y,0); continue; }         // sky
        if(y===5){ world.set(x,y,1); continue; }        // grass
        let id = y<22?2:3;                              // dirt then stone
        if(y>18 && Math.random()<0.10) id=4;            // copper
        if(y>32 && Math.random()<0.07) id=5;            // iron
        if(y>48 && Math.random()<0.04) id=6;            // silver
        if(y>64 && Math.random()<0.02) id=7;            // gold
        if(y>8  && Math.random()<0.015) id=0;           // caves
        world.set(x,y,id);
      }
    }
  }
  generateWorld();

  // ---- Player & buildings
  const SPAWN_X = TILE*10;
  const player={ x:SPAWN_X, y:TILE*5-22, w:16, h:22, vx:0, vy:0, facing:1,
    cash:0, stamina:100, staminaMax:100, carryCap:40, pickPower:2, speed:1.0, inventory:[] };
  const buildings=[
    { x:TILE*8,  y:TILE*5 - TILE*2, w:TILE*3, h:TILE*2, kind:'shop',    name:'Shop' },
    { x:TILE*13, y:TILE*5 - TILE*2, w:TILE*3, h:TILE*2, kind:'builder', name:'Builder' },
  ];
  function rectsIntersect(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

  // ---- Inventory helpers
  function totalWeight(){ return player.inventory.reduce((s,it)=> s + MATERIALS[it.id].weight*it.qty, 0); }
  function invAdd(id,qty=1){ const it=player.inventory.find(i=>i.id===id); if(it) it.qty+=qty; else player.inventory.push({id,qty}); }
  function invTrimTo(cap){ const items=player.inventory.map(it=>({...it,vpw:MATERIALS[it.id].value/Math.max(1,MATERIALS[it.id].weight)})).sort((a,b)=>a.vpw-b.vpw); let w=items.reduce((s,it)=>s+MATERIALS[it.id].weight*it.qty,0); for(const it of items){ while(w>cap&&it.qty>0){ it.qty--; w-=MATERIALS[it.id].weight; } } player.inventory=items.filter(i=>i.qty>0).map(({id,qty})=>({id,qty})); }
  function trySell(){ const shop=buildings.find(b=>b.kind==='shop'); if(shop && rectsIntersect(player,shop)) sellAll(); else say('Stand on the shop to sell.'); }
  function sellAll(){ if(!player.inventory.length){ say('Inventory empty.'); return; } let gained=0; for(const it of player.inventory){ gained+=MATERIALS[it.id].value * it.qty; } player.cash+=gained; player.inventory=[]; say(`Sold for $${gained}`); }

  // ---- Teleport with safe ground (R)
  function teleportHome(){ if(totalWeight()>player.carryCap){ invTrimTo(player.carryCap); say('Overweight. Excess destroyed.'); }
    const tx=Math.floor(SPAWN_X/TILE); world.set(tx,5,1); world.set(tx,6,2); // grass + dirt
    player.x=SPAWN_X; player.y=TILE*5-22; player.vx=0; player.vy=0; player.stamina=player.staminaMax; say('Teleported home.'); }

  // ---- Upgrades
  const upgrades = {
    pickaxe:  { key:'pickPower', name:'Pickaxe',           desc:'Mine harder materials', step:1,    max:10,  base:50,  scale:1.6 },
    boots:    { key:'speed',     name:'Boots',             desc:'Move faster',          step:0.10, max:2.0, base:80,  scale:1.5 },
    backpack: { key:'carryCap',  name:'Leather Backpack',  desc:'Increase carry cap',   step:20,   max:300, base:60,  scale:1.45 },
  };
  function priceFor(u){ const cur=player[u.key]; const baseLevel=u.key==='speed'?1.0:0.0; const level=Math.round((cur-baseLevel)/u.step); return Math.round(u.base*Math.pow(u.scale, level)); }
  function buy(u){ const cost=priceFor(u); if(player.cash<cost){ say('Not enough cash'); return; } const next=+(player[u.key]+u.step).toFixed(2); if(next>u.max){ say('Maxed'); return; } player.cash-=cost; player[u.key]=next; say(`${u.name} -> ${next}`); renderShop(); }

  function openShop(){ renderShop(); openModal(shopModal); }
  function renderShop(){ const items=[upgrades.pickaxe, upgrades.boots, upgrades.backpack]; shopBody.innerHTML = items.map(u=>{ const cur=player[u.key]; const nxt=Math.min(u.max, +(cur+u.step).toFixed(2)); const cost=priceFor(u); const disabled=(nxt<=cur||player.cash<cost)?'opacity-50 cursor-not-allowed':''; return `
      <div class='flex items-center justify-between gap-3 rounded-xl border border-slate-700 p-3'>
        <div>
          <div class='font-medium'>${u.name}</div>
          <div class='text-slate-400 text-xs'>${u.desc}</div>
          <div class='text-xs mt-1'>Current: <span class='text-slate-200'>${cur}</span> → Next: <span class='text-slate-200'>${nxt}</span></div>
        </div>
        <button data-key='${u.key}' class='buy px-3 py-1.5 rounded-md border border-slate-600 ${disabled}'>$${cost}</button>
      </div>`; }).join(''); shopBody.querySelectorAll('button.buy').forEach(btn=>{ btn.onclick=()=>{ const key=btn.getAttribute('data-key'); const u=Object.values(upgrades).find(x=>x.key===key); buy(u); }; }); }

  function openInventory(){ renderInventory(); openModal(invModal); }
  function renderInventory(){
    // Build count map for grid
    const counts=new Map(); for(const it of player.inventory){ counts.set(it.id, (counts.get(it.id)||0)+it.qty); }
    const entries = Array.from(counts.entries());
    const cells = entries.map(([id,qty])=>{
      const m=MATERIALS[id];
      return `<div class='border border-slate-700 rounded-lg p-2 flex flex-col items-start'>
        <div class='w-5 h-5 rounded-sm mb-1' style='background:${m.color||"transparent"}'></div>
        <div class='text-xs font-medium'>${m.name}</div>
        <div class='text-[11px] text-slate-400'>x${qty}</div>
      </div>`;
    });
    // Fill to 16 cells min for a grid feel
    while(cells.length<16) cells.push(`<div class='border border-dashed border-slate-700 rounded-lg p-2 h-[52px]'></div>`);
    invGrid.innerHTML = cells.join('');
  }

  // ---- Input
  const keys=new Set(); let mouse={down:false}; let lastDir='right';
  addEventListener('keydown',e=>{
    const k=e.key;
    if(k==='Escape'){ closeAllModals(); return; }
    const lk=k.toLowerCase(); keys.add(lk);
    if(lk==='a') lastDir='left';
    if(lk==='d') lastDir='right';
  });
  addEventListener('keyup',e=> keys.delete(e.key.toLowerCase()));
  canvas.addEventListener('mousedown',()=> mouse.down=true);
  addEventListener('mouseup',()=> mouse.down=false);

  // ---- Helpers
  function worldToTile(px,py){ return {tx:Math.floor(px/TILE), ty:Math.floor(py/TILE)}; }
  function isSolidAt(px,py){ const {tx,ty}=worldToTile(px,py); return MATERIALS[world.get(tx,ty)].solid; }

  // ---- Mining (Space; defaults down when idle)
  function tryMine(){
    const moving = keys.has('a')||keys.has('d');
    let dx=0,dy=0;
    if(!moving){ dy=1; }
    else if(lastDir==='left') dx=-1; else if(lastDir==='right') dx=1;
    const cx=player.x+player.w/2, cy=player.y+player.h/2; const {tx,ty}=worldToTile(cx,cy);
    const id=world.get(tx+dx, ty+dy); if(id<=0) return; const m=MATERIALS[id]; const cost=3+m.hard; if(m.hard>player.pickPower || player.stamina<cost) return;
    world.set(tx+dx, ty+dy, 0); player.stamina-=cost; invAdd(id,1); if(dy===1) player.vy=Math.max(player.vy,0.5);
  }

  // ---- Physics & collisions
  function resolveCollisions(){
    // Horizontal
    player.x += player.vx;
    if(player.vx>0){ if(isSolidAt(player.x+player.w,player.y) || isSolidAt(player.x+player.w,player.y+player.h-1)){ player.x=Math.floor((player.x+player.w)/TILE)*TILE-player.w-0.01; player.vx=0; } }
    else if(player.vx<0){ if(isSolidAt(player.x,player.y) || isSolidAt(player.x,player.y+player.h-1)){ player.x=Math.floor(player.x/TILE+1)*TILE+0.01; player.vx=0; } }
    // Vertical
    player.y += player.vy; player.onGround=false;
    if(player.vy>0){ if(isSolidAt(player.x+1,player.y+player.h) || isSolidAt(player.x+player.w-1,player.y+player.h)){ player.y=Math.floor((player.y+player.h)/TILE)*TILE-player.h-0.01; player.vy=0; player.onGround=true; } }
    else if(player.vy<0){ if(isSolidAt(player.x+1,player.y) || isSolidAt(player.x+player.w-1,player.y)){ player.y=Math.floor(player.y/TILE+1)*TILE+0.01; player.vy=0; } }
  }

  // ---- Game loop
  const camera={x:0,y:0};
  function tick(){
    if(!isUIOpen()){
      // movement A/D
      if(keys.has('a')){ player.vx -= MOVE_ACC * player.speed; player.facing=-1; }
      if(keys.has('d')){ player.vx += MOVE_ACC * player.speed; player.facing=1; }
      // mine Space
      if(keys.has(' ')){ tryMine(); keys.delete(' '); }
      // interact F (open shop)
      if(keys.has('f')){ const shop=buildings.find(b=>b.kind==='shop'); if(shop && rectsIntersect(player,shop)) openShop(); else say('No one nearby.'); keys.delete('f'); }
      // inventory E
      if(keys.has('e')){ openInventory(); keys.delete('e'); }
      // teleport R
      if(keys.has('r')){ teleportHome(); keys.delete('r'); }
    }

    // physics always run
    player.vy += GRAV; if(player.vy>18) player.vy=18; player.vx = Math.max(-MAX_HSPEED*player.speed, Math.min(MAX_HSPEED*player.speed, player.vx)); player.vx *= FRICTION;
    resolveCollisions();

    // keep falling if nothing below
    if(!isSolidAt(player.x+1, player.y+player.h) && !isSolidAt(player.x+player.w-1, player.y+player.h)) player.vy += GRAV*0.5;

    // camera
    camera.x = Math.max(0, Math.min(MAP_W*TILE - canvas.width,  player.x + player.w/2 - canvas.width/2));
    camera.y = Math.max(0, Math.min(MAP_H*TILE - canvas.height, player.y + player.h/2 - canvas.height/2));
  }

  function draw(){
    ctx.fillStyle='#0b0d12'; ctx.fillRect(0,0,canvas.width,canvas.height);
    // tiles in view
    const x0=Math.max(0,Math.floor(camera.x/TILE)), y0=Math.max(0,Math.floor(camera.y/TILE));
    const x1=Math.min(MAP_W,Math.ceil((camera.x+canvas.width)/TILE)), y1=Math.min(MAP_H,Math.ceil((camera.y+canvas.height)/TILE));
    for(let ty=y0;ty<y1;ty++) for(let tx=x0;tx<x1;tx++){ const id=world.get(tx,ty); if(id===0) continue; ctx.fillStyle=MATERIALS[id].color; ctx.fillRect(tx*TILE-camera.x,ty*TILE-camera.y,TILE,TILE); }
    // buildings
    for(const b of buildings){ ctx.fillStyle=b.kind==='shop'?'#2563eb':'#16a34a'; ctx.fillRect(b.x-camera.x,b.y-camera.y,b.w,b.h); ctx.fillStyle='#e5e7eb'; ctx.font='12px system-ui'; ctx.fillText(b.name,b.x-camera.x+2,b.y-camera.y-4); }
    // player
    ctx.fillStyle='#f59e0b'; ctx.fillRect(player.x-camera.x,player.y-camera.y,player.w,player.h);

    statsEl.innerHTML = `Cash: $${player.cash} | Stamina: ${Math.floor(player.stamina)}/${player.staminaMax} | Weight: ${totalWeight()}/${player.carryCap} | Pick: ${player.pickPower} | Speed×${player.speed.toFixed(2)}`;
  }

  function loop(){ tick(); draw(); requestAnimationFrame(loop); }
  requestAnimationFrame(loop);

  // resize
  function fit(){ const dpr=Math.min(2,window.devicePixelRatio||1); canvas.width=Math.floor(innerWidth*dpr); canvas.height=Math.floor(innerHeight*dpr); }
  addEventListener('resize',fit); fit();
})();
</script>
</body>
</html>
